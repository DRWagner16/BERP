<!DOCTYPE html>
<html>
<head>
    <title>BERP Interactive Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; margin: 0; padding: 20px; }
        .dashboard-container { max-width: 1400px; margin: auto; }
        .header { background: #1a5276; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; gap: 20px; align-items: center; }
        .grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 400px; }
        select { padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; min-width: 200px; }
        label { font-weight: bold; color: #34495e; }
        
        /* Metrics styling */
        .metric-box { text-align: center; padding: 20px; background: #ecf0f1; border-radius: 8px; margin-bottom: 20px; }
        .metric-val { font-size: 2.5em; font-weight: bold; color: #2c3e50; }
        .metric-lbl { color: #7f8c8d; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <h1>BERP Interactive Dashboard</h1>
        <p>Real-time Impact Tracking & Visualization</p>
    </div>

    <div class="controls">
        <div>
            <label>Filter by Status:</label><br>
            <select id="statusFilter" onchange="updateDashboard()">
                <option value="All">All Projects</option>
                <option value="Yes">Implemented Only</option>
                <option value="In Progress">In Progress</option>
            </select>
        </div>
        
        <div>
            <label>Filter by County:</label><br>
            <select id="countyFilter" onchange="updateDashboard()">
                <option value="All">All Counties</option>
                </select>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3 style="margin-top:0;">Utah Impact Map</h3>
            <div id="utahMap" style="height: 500px;">Loading Map...</div>
        </div>
        
        <div class="card">
            <h3 style="margin-top:0;">Program Metrics</h3>
            <div id="metricsBox">Loading...</div>
            
            <h3 style="margin-top:20px;">Cost vs. Savings</h3>
            <div id="costChart" style="height: 300px;"></div>
        </div>
    </div>
</div>

<script>
    let globalData = [];
    const geoJsonUrl = "https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json"; 

    // 1. Fetch Data
    d3.json('site_data.json').then(function(data) {
        globalData = data;
        populateFilters();
        updateDashboard();
    });

    // 2. Populate Dropdowns
    function populateFilters() {
        // Get unique counties, filter out empties, and sort
        let counties = [...new Set(globalData.map(d => d.County))].filter(Boolean).sort();
        let selector = document.getElementById('countyFilter');
        counties.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c;
            opt.innerHTML = c;
            selector.appendChild(opt);
        });
    }

    // 3. The Main Update Function
    function updateDashboard() {
        let statusSel = document.getElementById('statusFilter').value;
        let countySel = document.getElementById('countyFilter').value;

        // Filter Data
        let filtered = globalData.filter(d => {
            let statusMatch = (statusSel === "All") || (d['Implemented? Yes/No/In Progress'] === statusSel);
            let countyMatch = (countySel === "All") || (d.County === countySel);
            return statusMatch && countyMatch;
        });

        // Update Charts
        renderMap(filtered);
        renderMetrics(filtered);
        renderCostChart(filtered);
    }

    function renderMetrics(data) {
        let totalCO2 = d3.sum(data, d => d.Total_CO2_Tons);
        let totalSavings = d3.sum(data, d => d['Total Cost Savings']);
        let count = data.length;

        document.getElementById('metricsBox').innerHTML = `
            <div class="metric-box">
                <div class="metric-val">${count}</div>
                <div class="metric-lbl">Projects Selected</div>
            </div>
            <div class="metric-box">
                <div class="metric-val" style="color:#27ae60">${totalCO2.toFixed(1)}</div>
                <div class="metric-lbl">Tons CO2 Reduced</div>
            </div>
            <div class="metric-box">
                <div class="metric-val" style="color:#2980b9">$${totalSavings.toLocaleString()}</div>
                <div class="metric-lbl">Annual Savings</div>
            </div>
        `;
    }

    function renderMap(data) {
        // 1. Prepare Data
        let fipsMap = d3.rollup(data, v => d3.sum(v, d => d.Total_CO2_Tons), d => d.FIPS);
        let locations = Array.from(fipsMap.keys());
        let zValues = Array.from(fipsMap.values());
        
        let hoverText = locations.map(fips => {
            let match = data.find(d => d.FIPS === fips);
            let val = fipsMap.get(fips).toFixed(1);
            return match ? `${match.County}: ${val} Tons` : fips;
        });

        // 2. Define Background Layer (Gray Utah)
        let allUtahFips = [
            "49001", "49003", "49005", "49007", "49009", "49011", "49013", "49015", 
            "49017", "49019", "49021", "49023", "49025", "49027", "49029", "49031", 
            "49033", "49035", "49037", "49039", "49041", "49043", "49045", "49047", 
            "49049", "49051", "49053", "49055", "49057"
        ];

        let backgroundTrace = {
            type: 'choropleth',
            geojson: geoJsonUrl,
            locations: allUtahFips, 
            z: Array(allUtahFips.length).fill(0),
            colorscale: [['0.0', '#eeeeee'], ['1.0', '#eeeeee']], 
            showscale: false, 
            marker: { line: { width: 0.5, color: '#bdbdbd' } },
            hoverinfo: 'skip'
        };

        // 3. Define Data Layer (Teal Projects)
        let dataTrace = {
            type: 'choropleth',
            geojson: geoJsonUrl,
            locations: locations, 
            z: zValues,           
            text: hoverText,
            colorscale: 'Teal',
            marker: { line: { width: 1, color: 'white' } },
            colorbar: { title: 'CO2 (Tons)' },
            hovertemplate: '<b>%{text}</b><extra></extra>' 
        };

        // 4. Layout (Zoomed to Utah)
        let layout = {
            title: { text: 'Utah CO2 Reduction by County', y: 0.95 },
            geo: {
                scope: 'usa',
                projection: { type: 'albers usa' },
                showlakes: false,
                center: { lon: -111.5, lat: 39.4 }, 
                lonaxis: { range: [-114.5, -108.5] },
                lataxis: { range: [36.5, 42.5] }
            },
            margin: {l:0, r:0, t:30, b:0},
            dragmode: false
        };

        Plotly.newPlot('utahMap', [backgroundTrace, dataTrace], layout, {responsive: true});
    }

    function renderCostChart(data) {
        let trace = {
            x: data.map(d => d['Implementation Costs']),
            y: data.map(d => d['Total Cost Savings']),
            mode: 'markers',
            type: 'scatter',
            text: data.map(d => d['Recommendation Name']),
            marker: { 
                size: 12, 
                color: data.map(d => d.Total_CO2_Tons), 
                colorscale: 'Viridis',
                showscale: false
            }
        };
        Plotly.newPlot('costChart', [trace], {
            xaxis: {title: 'Implementation Cost ($)'},
            yaxis: {title: 'Annual Savings ($)'},
            margin: {l:50, r:20, t:20, b:40}
        }, {responsive: true});
    }
</script>

</body>
</html>
