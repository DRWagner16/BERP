<!DOCTYPE html>
<html>
<head>
    <title>BERP Interactive Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; margin: 0; padding: 20px; }
        .dashboard-container { max-width: 1400px; margin: auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        select { padding: 8px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <h1>BERP Interactive Dashboard</h1>
        <p>Interactive Map & Data Explorer</p>
    </div>

    <div class="controls">
        <label><b>Filter by Status:</b></label>
        <select id="statusFilter" onchange="updateDashboard()">
            <option value="All">All Projects</option>
            <option value="Yes">Implemented Only</option>
            <option value="In Progress">In Progress</option>
        </select>
        
        <label style="margin-left: 20px;"><b>Filter by County:</b></label>
        <select id="countyFilter" onchange="updateDashboard()">
            <option value="All">All Counties</option>
            </select>
    </div>

    <div class="grid" style="grid-template-columns: 2fr 1fr;">
        <div class="card">
            <h3>Utah Impact Map</h3>
            <div id="utahMap" style="height: 500px;"></div>
        </div>
        <div class="card">
            <h3>Program Metrics</h3>
            <div id="metricsBox">Loading...</div>
            <div id="costChart" style="height: 400px;"></div>
        </div>
    </div>
</div>

<script>
    let globalData = [];
    let geoJsonUrl = "https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json"; // Standard US Counties

    // 1. Fetch Data
    d3.json('site_data.json').then(function(data) {
        globalData = data;
        populateFilters();
        updateDashboard();
    });

    // 2. Populate Dropdowns
    function populateFilters() {
        let counties = [...new Set(globalData.map(d => d.County))].sort();
        let selector = document.getElementById('countyFilter');
        counties.forEach(c => {
            if(c) {
                let opt = document.createElement('option');
                opt.value = c;
                opt.innerHTML = c;
                selector.appendChild(opt);
            }
        });
    }

    // 3. The Main Update Function
    function updateDashboard() {
        let statusSel = document.getElementById('statusFilter').value;
        let countySel = document.getElementById('countyFilter').value;

        // Filter Data
        let filtered = globalData.filter(d => {
            let statusMatch = (statusSel === "All") || (d['Implemented? Yes/No/In Progress'] === statusSel);
            let countyMatch = (countySel === "All") || (d.County === countySel);
            return statusMatch && countyMatch;
        });

        // Update Map
        renderMap(filtered);
        
        // Update Metrics
        let totalCO2 = d3.sum(filtered, d => d.Total_CO2_Tons);
        let totalSavings = d3.sum(filtered, d => d['Total Cost Savings']);
        document.getElementById('metricsBox').innerHTML = `
            <h2>${filtered.length} Projects</h2>
            <h2 style="color:green">${totalCO2.toFixed(1)} Tons CO2</h2>
            <h2 style="color:blue">$${totalSavings.toLocaleString()} Savings</h2>
        `;

        // Update Charts
        renderCostChart(filtered);
    }

    function renderMap(data) {
        // Aggregate CO2 by County for the map color
        let countyData = d3.rollup(data, v => d3.sum(v, d => d.Total_CO2_Tons), d => d.County);
        let mapLocs = Array.from(countyData.keys());
        let mapVals = Array.from(countyData.values());

        // Note: For a robust Utah map, we usually match County Names to FIPS codes.
        // For this demo, we use a simple scatter plot on top of a map background
        // because automatic County Name matching can be tricky without a lookup table.
        // If you have specific Lat/Lon in your sheet, we can use those!
        
        let trace = {
            type: 'choropleth',
            locationmode: 'USA-states', // We will zoom into Utah
            locations: Array(mapLocs.length).fill('UT'), // All are in Utah
            z: mapVals,
            text: mapLocs,
            colorscale: 'Teal',
            marker: { line: { width: 0 } }
        };

        // ALTERNATIVE: BUBBLE MAP (Simpler without FIPS codes)
        // We will assume some standard lat/lons for demo or just list them.
        // Since we don't have FIPS codes in your sheet, a Choropleth is hard.
        // Let's stick to a simple bar chart for counties for now, 
        // OR ask if you want to add a "FIPS" column to your sheet?
        
        // For now, let's render a Bar Chart in the "Map" slot until we solve the GeoJSON link.
        let mapData = [{
            x: mapLocs,
            y: mapVals,
            type: 'bar',
            marker: {color: 'teal'}
        }];
        
        Plotly.newPlot('utahMap', mapData, {title: 'CO2 Reduction by County'});
    }

    function renderCostChart(data) {
        let trace = {
            x: data.map(d => d['Implementation Costs']),
            y: data.map(d => d['Total Cost Savings']),
            mode: 'markers',
            type: 'scatter',
            text: data.map(d => d['Recommendation Name']),
            marker: { size: 10, color: data.map(d => d.Total_CO2_Tons), colorscale: 'Viridis' }
        };
        Plotly.newPlot('costChart', [trace], {
            title: 'Cost vs Savings (Color=CO2)',
            xaxis: {title: 'Implementation Cost'},
            yaxis: {title: 'Annual Savings'}
        });
    }
</script>

</body>
</html>
